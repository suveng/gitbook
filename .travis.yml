sudo: required
language: node_js
node_js:
- stable
before_install:
- export TZ='Asia/Shanghai'
- npm install gitbook-cli -g
- npm install svgexport -g
- gitbook fetch 3.2.3
- sudo apt-get update -qq
- sudo -v && wget --no-check-certificate -nv -O- https://raw.githubusercontent.com/kovidgoyal/calibre/master/setup/linux-installer.py
  | sudo python -c "import sys; main=lambda:sys.stderr.write('Download failed\n');
  exec(sys.stdin.read()); main()"
install:
- gitbook install
before_script:
- mkdir -p ~/.fonts/noto
- mkdir -p ~/raw_fonts/{NotoSans-unhinted,NotoSansCJKsc-hinted,NotoSansCJKtc-hinted}
- wget -P ~/raw_fonts https://noto-website-2.storage.googleapis.com/pkgs/NotoSans-unhinted.zip
- unzip ~/raw_fonts/NotoSans-unhinted.zip -d ~/raw_fonts/NotoSans-unhinted
- wget -P ~/raw_fonts https://noto-website-2.storage.googleapis.com/pkgs/NotoSansCJKsc-hinted.zip
- unzip ~/raw_fonts/NotoSansCJKsc-hinted.zip -d ~/raw_fonts/NotoSansCJKsc-hinted
- wget -P ~/raw_fonts https://noto-website-2.storage.googleapis.com/pkgs/NotoSansCJKtc-hinted.zip
- unzip ~/raw_fonts/NotoSansCJKtc-hinted.zip -d ~/raw_fonts/NotoSansCJKtc-hinted
script:
- mv -t ~/.fonts/noto ~/raw_fonts/NotoSansCJKsc-hinted/*-DemiLight.otf ~/raw_fonts/NotoSansCJKsc-hinted/*-Bold.otf
  ~/raw_fonts/NotoSansCJKsc-hinted/*-Black.otf
- sudo fc-cache -f -v
- gitbook pdf .
- gitbook epub .
- gitbook mobi .
- rm ~/.fonts/noto/*.otf
- gitbook build .
branches:
  only:
  - master
  - /^v\d+\.\d+\.\d+$/
before_deploy:
- git config --local user.name "suveng"
- git config --local user.email "suveng@163.com"
deploy:
  - provider: pages
    skip_cleanup: true
    local_dir: _book
    name: suveng
    email: suveng@163.com
    verbose: true
    on:
      branch: master
    github_token:
      secure: RMuPvyD5RDeo5xRKh0I6DDPtD+u7mU6XqSRf96ePwho4scG529qHe7NEoUM754yPyKHz839sjhgJG3YqG6NpVrtNnZrDAcC7mnhnUxucNkalyEwxUX06LUckr3oWY4DMw/LcB7y54HIM8L9rjSXZO7EQZGk20lPQwS5mpGDh0kJYB+JWr+yRG9v5yYGB+ZdQyPK8c7QZwfwpDikBcwncR5dPAXoITAObhsW/W9of0y1YmYc+nG5VglkTDmTX/EJ5QUqRr47uSLqMPouagbNlRhvLdMXeIKCWuubs7AClGvJ+LdzJ7+g64blkYdGQWH4lK5ouEezi14/pAUAPQuk0ybsJstvDIWXNEmMtqy5p+BQqKwnGlDQLSlC5MLvNddlVaznH8Q8qNwdeScQM/WRwuE/9XbmkDaOUfl8MDSDsrUlGXLyr/QP6RN4j2zxBdwkRnukjcl0n8ZyMyf9jHLUY3VT9TJKZ4imPURjWHstfOVGKpSsH9E9JWSvzkL7vBIcj2/4KDJKRcKLsCmihz+0N7RyMCXhp3aZU45e/nmJ5OZcCnWlrOh9XCQjh2DDUv5xsMSlp3KhYkugvAZGcldlfA9rmagYvO6T6cJ3QZC4R3lKrWncmruakkKeoPRbcs4XlP/bXSsp8a0LgumTzM6MdyZmc/lZyhCJaQx+/Vr5Zqto=
  - provider: releases
    file:
    - "book.epub"
    - "book.mobi"
    - "book.pdf"
    skip_cleanup: true
    overwrite: true
    api_key:
      secure: RMuPvyD5RDeo5xRKh0I6DDPtD+u7mU6XqSRf96ePwho4scG529qHe7NEoUM754yPyKHz839sjhgJG3YqG6NpVrtNnZrDAcC7mnhnUxucNkalyEwxUX06LUckr3oWY4DMw/LcB7y54HIM8L9rjSXZO7EQZGk20lPQwS5mpGDh0kJYB+JWr+yRG9v5yYGB+ZdQyPK8c7QZwfwpDikBcwncR5dPAXoITAObhsW/W9of0y1YmYc+nG5VglkTDmTX/EJ5QUqRr47uSLqMPouagbNlRhvLdMXeIKCWuubs7AClGvJ+LdzJ7+g64blkYdGQWH4lK5ouEezi14/pAUAPQuk0ybsJstvDIWXNEmMtqy5p+BQqKwnGlDQLSlC5MLvNddlVaznH8Q8qNwdeScQM/WRwuE/9XbmkDaOUfl8MDSDsrUlGXLyr/QP6RN4j2zxBdwkRnukjcl0n8ZyMyf9jHLUY3VT9TJKZ4imPURjWHstfOVGKpSsH9E9JWSvzkL7vBIcj2/4KDJKRcKLsCmihz+0N7RyMCXhp3aZU45e/nmJ5OZcCnWlrOh9XCQjh2DDUv5xsMSlp3KhYkugvAZGcldlfA9rmagYvO6T6cJ3QZC4R3lKrWncmruakkKeoPRbcs4XlP/bXSsp8a0LgumTzM6MdyZmc/lZyhCJaQx+/Vr5Zqto=
    on:
      tags: true
after_success:
- ls -lh